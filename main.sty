\ProvidesPackage{main}

% Warn about obsolete commands, classes and packages
\RequirePackage[l2tabu, orthodox]{nag}

% Layout of document
\usepackage[a4paper,margin=1in]{geometry}
\setlength{\marginparwidth}{2cm} 

% Scale fonts
\usepackage{anyfontsize}

% Improves spacing between words
\usepackage{microtype}

% ams math stuff, theorem/proof environment, etc.
\usepackage{mathtools, amsthm, thmtools, amssymb, amsfonts, mathrsfs}
\usepackage{xcolor}


% Indent first line of paragraph after section, chapter, etc. start
\usepackage{indentfirst}

% Show keys of \label when document in draft mode
\usepackage[notref, notcite, color]{showkeys}

% Draft mode stuff
\usepackage{ifdraft, xparse}
\ifdraft{
    \usepackage{draftwatermark}
    \SetWatermarkAngle{90}
    \SetWatermarkFontSize{2cm}
    \SetWatermarkHorCenter{1cm}
    }{} % sets DRAFT watermark along margins in draft mode


% For typing syntax-highlighted source code
\usepackage[final]{minted}

% For enumerate environment. inline option allows for inline enumerate
% for starred environment \begin{enumerate*}\item ... \end{enumerate}
\usepackage[inline]{enumitem}

% For captions
\usepackage{caption, subcaption}

% For improved tables
\usepackage{tabularx}
\usepackage{booktabs, multicol, multirow, adjustbox, blkarray}

% Horizontal fraction formatting using \sfrac{num}{den}
\usepackage{xfrac}
\UseCollection{xfrac}{plainmath}

% Temporary fix until xfrac package is fixed
\renewcommand{\sfrac}[2]{#1/#2}

% Improved formatting for \left ... \right pairs
\usepackage{mleftright}
\mleftright

% Theorem environment setup
\usepackage{tikz, amssymb, tcolorbox}
\usepackage{xcolor}
\theoremstyle{definition}
% Exercise environment --- optional argument in brackets adds number of
% points to title
\usetikzlibrary{positioning}
\tcbuselibrary{theorems, skins, breakable}
% Exercise environment --- optional argument in brackets adds number of
% points to title
\newcounter{exercise}[section]
\newtcbtheorem{exercisebase}{\stepcounter{exercise}Exercise~\arabic{exercise}}{breakable,
colframe=red!35!black,fonttitle=\bfseries, separator sign={ }}{exe}
\newenvironment{exercise}[1][]{%
    \begin{exercisebase*}{\ifthenelse{\equal{#1}{}}{}{(#1 Points)}}{}}{\end{exercisebase*}}
\newtheorem{wexercise}{Worked Exercise}[section]
\theoremstyle{plain}
\newtheorem{statement}{Statement}[section]
\tcbuselibrary{skins, breakable, minted, listings, most}
\tcbset{shield externalize}

\newtheoremstyle{tcb-drop-in-thm}% 〈name〉
                {}% 〈Space above〉1
                {}% 〈Space below 〉1
                {}% 〈Body font〉
                {}% 〈Indent amount〉2
                {\bfseries\color{white}}% 〈Theorem head font〉
                {}% 〈Punctuation after theorem head 〉
                {\newline}% 〈Space after theorem head 〉3
                {\thmname{#1}\thmnumber{ #2}\thmnote{ $\blacktriangleright$ #3}\\*[-1.5ex]}% 〈Theorem head spec (can be left empty, meaning ‘normal’ )〉

\theoremstyle{tcb-drop-in-thm}
\newtheorem{theorem}{Theorem}[section]
\newtheorem{lemma}[theorem]{Lemma}
\newtheorem{corollary}[theorem]{Corollary}
\newtheorem{problem}{Problem}[section]
\newtheorem{definition}{Definition}[section]
\newtheorem{example}{Example}[section]

\tcolorboxenvironment{theorem}{%
    colback=gray!25,
    colframe=gray!90!black,
    enhanced,
    top=0mm,
    overlay={\begin{tcbclipinterior}
        \fill[gray!90!black] (frame.north west)rectangle ([yshift=-5.5mm]frame.north east);
            \end{tcbclipinterior}}
}

\tcolorboxenvironment{lemma}{%
colback=gray!25,
colframe=gray!90!black,
enhanced,
top=0mm,
overlay={\begin{tcbclipinterior}
    \fill[gray!90!black] (frame.north west)rectangle ([yshift=-5.5mm]frame.north east);
        \end{tcbclipinterior}}
}

\tcolorboxenvironment{corollary}{%
colback=gray!25,
colframe=gray!90!black,
enhanced,
top=0mm,
overlay={\begin{tcbclipinterior}
    \fill[gray!90!black] (frame.north west)rectangle ([yshift=-5.5mm]frame.north east);
        \end{tcbclipinterior}}
}

\tcolorboxenvironment{proposition}{%
colback=gray!25,
colframe=gray!90!black,
enhanced,
top=0mm,
overlay={\begin{tcbclipinterior}
    \fill[gray!90!black] (frame.north west)rectangle ([yshift=-5.5mm]frame.north east);
        \end{tcbclipinterior}}
}

\tcolorboxenvironment{problem}{%
colback=red!5,
colframe=red!60!black,
enhanced,
top=0mm,
overlay={\begin{tcbclipinterior}
    \fill[red!60!black] (frame.north west)rectangle ([yshift=-5.5mm]frame.north east);
        \end{tcbclipinterior}}
}

\tcolorboxenvironment{definition}{%
colback=blue!5,
colframe=blue!35!black,
enhanced,
top=0mm,
overlay={\begin{tcbclipinterior}
    \fill[blue!35!black] (frame.north west)rectangle ([yshift=-5.5mm]frame.north east);
        \end{tcbclipinterior}}
}

\tcolorboxenvironment{example}{%
colback=green!5,
colframe=green!35!black,
enhanced,
top=0mm,
overlay={\begin{tcbclipinterior}
    \fill[green!35!black] (frame.north west)rectangle ([yshift=-5.5mm]frame.north east);
        \end{tcbclipinterior}}
}


% Footnote stuff for theorem boxes. If footnote in theorem, place \savenotes before
% environment and \spewnotes after.
\usepackage{footnote}
\renewcommand{\thempfootnote}{\arabic{mpfootnote}}

% Pseudocode 
\usepackage{algorithm}
\usepackage[noEnd=true,indLines,rightComments=false]{algpseudocodex}
\usepackage{xcolor}
\usepackage{xspace}
\definecolor{algcolor}{HTML}{2979FF}
\definecolor{inputcolor}{rgb}{1, 0, 0}
\definecolor{outputcolor}{rgb}{1, 0, 0}
\definecolor{keywordcolor}{HTML}{80CBC4}

\algnewcommand\algorithmicto{\textbf{to}}%
\algnewcommand\algorithmicdownto{\textbf{down to}}%
\algnewcommand\algorithmicforeach{\textbf{for each}}%
\algnewcommand{\algorithmicdone}{\textbf{done}}%
\newcommand{\AlgName}[1]{{\textcolor{algcolor}{#1}}}

\makeatletter
\algdef{SE}[FOREACH]{ForEach}{EndForEach}[1]{\algpx@startIndent\algpx@startCodeCommand\algorithmicforeach\ #1\ \algorithmicdo}{\algpx@endIndent\algpx@startCodeCommand\algorithmicend\ \algorithmicforeach}%
\algdef{SE}[FORRANGE]{ForRange}{EndForRange}[3]{\algpx@startIndent\algpx@startCodeCommand\algorithmicfor\ #1\ \ensuremath{\gets}\ #2\ \algorithmicto\ #3\ \algorithmicdo}{\algpx@endIndent\algpx@startCodeCommand\algorithmicend\ \algorithmicfor}%
\algdef{SE}[FORRANGEDOWN]{ForRangeDown}{EndForRangeDown}[3]{\algpx@startIndent\algpx@startCodeCommand\algorithmicfor\ #1\ \ensuremath{\gets}\ #2\ \algorithmicdownto\ #3\ \algorithmicdo}{\algpx@endIndent\algpx@startCodeCommand\algorithmicend\ \algorithmicfor}%
\algdef{SE}[DONTIMES]{DoNTimes}{EndDoNTimes}[1]{\algpx@startIndent\algpx@startCodeCommand\algorithmicdo\ #1\ times}{\algpx@endIndent\algpx@startCodeCommand\algorithmicdone}%
\ifbool{algpx@noEnd}{%
    \algtext*{EndForEach}%
    \algtext*{EndForRange}%
    \algtext*{EndForRangeDown}%
	\algtext*{EndDoNTimes}%
    %
      % end indent line after (not before), to get correct y position for multiline text in last command
    \apptocmd{\EndForEach}{\algpx@endIndent}{}{}%
    \apptocmd{\EndForRange}{\algpx@endIndent}{}{}%
    \apptocmd{\EndForRangeDown}{\algpx@endIndent}{}{}%
	\apptocmd{\EndDoNTimes}{\algpx@endIndent}{}{}%
}{}%
\pretocmd{\ForEach}{\algpx@endCodeCommand}{}{}
\pretocmd{\ForRange}{\algpx@endCodeCommand}{}{}
\pretocmd{\ForRangeDown}{\algpx@endCodeCommand}{}{}
\pretocmd{\DoNTimes}{\algpx@endCodeCommand}{}{}

% for end commands that may not be printed, tell endCodeCommand whether we are using noEnd
\ifbool{algpx@noEnd}{%
  \pretocmd{\EndForEach}{\algpx@endCodeCommand[1]}{}{}%
  \pretocmd{\EndForRange}{\algpx@endCodeCommand[1]}{}{}%
  \pretocmd{\EndForRangeDown}{\algpx@endCodeCommand[1]}{}{}%
  \pretocmd{\EndDoNTimes}{\algpx@endCodeCommand[1]}{}{}%
}{%
\pretocmd{\EndForEach}{\algpx@endCodeCommand[0]}{}{}%
\pretocmd{\EndForRange}{\algpx@endCodeCommand[0]}{}{}%
\pretocmd{\EndForRangeDown}{\algpx@endCodeCommand[0]}{}{}%
\pretocmd{\EndDoNTimes}{\algpx@endCodeCommand[0]}{}{}%
}%
\makeatother

\renewcommand{\gets}{=}
\newcommand{\equalto}{==}
\newcommand{\notequalto}{\neq}

\newcommand{\False}{\texttt{False}\xspace}
\newcommand{\True}{\texttt{True}\xspace}
\newcommand{\Null}{\texttt{Null}\xspace}
\newcommand{\AlgInput}[1]{\Statex \textcolor{inputcolor}{\hspace*{\algorithmicindent}Input\phantom{O} \(\triangleright\)} #1}
\newcommand{\AlgOutput}[1]{\Statex \textcolor{outputcolor}{\hspace*{\algorithmicindent}Output \(\triangleright\)} #1}
\renewcommand*\Call[2]{\textproc{#1}\left(#2\right)}

% Useful commands
\newcommand{\set}[1]{\left\lbrace#1\right\rbrace}
\newcommand{\suchthat}{\mid}
\newcommand{\floor}[1]{\left\lfloor#1\right\rfloor}
\newcommand{\ceil}[1]{\left\lceil#1\right\rceil}
\newcommand{\card}[1]{\left\lvert#1\right\rvert}
\newcommand{\abs}[1]{\left\lvert#1\right\rvert}
\newcommand{\bigO}[1]{\mathcal{O}\left(#1\right)}
\newcommand{\bigOm}[1]{\Omega\left(#1\right)}
\newcommand{\bigTh}[1]{\Theta\left(#1\right)}
\newcommand{\littleO}[1]{o\left(#1\right)}
\newcommand{\littleOm}[1]{\omega\left(#1\right)}
\newcommand{\nth}[1]{#1-th}

% Tikz and PGF stuff
\usepackage{tikz, pgfplots}
\pgfplotsset{compat=newest}
\usetikzlibrary{shapes, shapes.misc, decorations, fit, backgrounds, positioning, patterns, shadows, calc, arrows, arrows.meta, trees}
\tikzset{>={Latex[width=2mm,length=2mm]}}
\usetikzlibrary{external}
\tikzexternalize[prefix=tikzimages/]
\newcommand\DoubleLine[7][4pt]{%
    \path(#2)--(#3)coordinate[at start](h1)coordinate[at end](h2);
    \draw[#4]($(h1)!#1!90:(h2)$)-- node [auto=left] {#5} ($(h2)!#1!-90:(h1)$); 
    \draw[#6]($(h1)!#1!-90:(h2)$)-- node [auto=right] {#7} ($(h2)!#1!90:(h1)$);
}
\tikzset{arrowhead/.style=
         {sloped,isosceles triangle,anchor=apex,fill=black,inner sep=2pt}}
\tikzset{
  point/.style={
    draw,
    circle,
    inner sep=0pt,
    outer sep=0pt,
    minimum size=0.1cm,
    fill
  }
}


% Solution environment
\newenvironment{solution}{\begin{proof}[\textnormal{\textbf{Solution}}]}{\end{proof}}

\renewcommand{\Pr}{\mathbb{P}}
\DeclareMathOperator{\var}{Var}
\NewDocumentCommand{\prob}{o m}{\IfValueTF{#1}{\operatorname{\Pr}_{#1}}{\operatorname{\Pr}}\left(#2\right)}
\NewDocumentCommand{\expectation}{o m}{\IfValueTF{#1}{\operatorname{\underset{\scriptscriptstyle#1}{\mathbb{E}}}}{\operatorname{\mathbb{E}}}\left[#2\right]}
% \newcommand{\expectation}[1]{\operatorname{\mathbb{E}}\left[#1\right]}
\newcommand{\variance}[1]{\operatorname{\var}\left[#1\right]}
\newcommand{\covariance}[2]{\operatorname{cov}\left(#1,#2\right)}
\newcommand{\given}{\mid}
\newcommand{\divides}{\mid}
\newcommand{\drawnfrom}{\sim}
\newcommand{\indicator}[1]{\ensuremath{1_{#1}}}

\newcommand{\naturals}{\ensuremath{\mathbb{N}}}
\newcommand{\reals}{\ensuremath{\mathbb{R}}}
\newcommand{\isomorphic}{\cong}
\renewcommand{\vec}[1]{\ensuremath{\mathbf{#1}}}

\newcommand{\entropy}[1]{\ensuremath{H\left(#1\right)}}
\newcommand{\binentropy}[1]{\ensuremath{h\left(#1\right)}}
\newcommand{\sampleavg}[1]{\ensuremath{\hat{#1}}}
\newcommand{\relentropy}[2]{\ensuremath{D\left(#1 \parallel #2\right)}}
\newcommand{\identically}{\equiv}
\newcommand{\composedwith}{\circ}
\newcommand{\length}[1]{\ensuremath{\ell\left(#1\right)}}

% Todo stuff
\usepackage{todonotes}
\makeatletter
\renewcommand{\todo}[2][]{\tikzexternaldisable\@todo[#1]{#2}\tikzexternalenable}
\makeatother
% BELOW SHOULD ALWAYS BE AT END OF PREAMBLE
% hyperlinks in document
\usepackage[colorlinks=true, final]{hyperref}
\usepackage[noabbrev,capitalize]{cleveref}
\crefname{line}{line}{lines}